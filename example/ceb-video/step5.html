<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Import fontawesome for icons-->
  <link rel="stylesheet" href="https://opensource.keycdn.com/fontawesome/4.7.0/font-awesome.min.css"
        integrity="sha384-dNpIIXE8U05kAbPhy3G1cz+yZmTzA6CY8Vg/u2L9xRnHjJiAK76m2BIEaSEV+/aU" crossorigin="anonymous">
  <!-- Import the polyfill to provide the CustomElement implementation if required-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/document-register-element/1.3.0/document-register-element.js"
          crossorigin="anonymous"></script>
  <!-- Import the ceb library -->
  <script src="live/dist/umd/ceb.min.js"></script>
  <style>
    ceb-video {
      display: block;
      height: auto;
      width: auto;
      border: solid thin lightgray;
      padding: 0.125rem;
    }

    ceb-video video {
      display: block;
      width: 100%;
    }

    ceb-video .controls {
      margin-top: 0.125rem;
      display: flex;
      align-items: center;
    }

    ceb-video .controls [name=duration] {
      flex: 3;
    }

    ceb-video .controls [name=volume] {
      flex: 1;
    }
  </style>
</head>

<!-- Define and register the CustomElement 'ceb-input'. -->
<script>
  var cebVideoBuilder = ceb.element();
</script>

<!--
  Template of ceb-video.
  The embedded video element is created from the template.
  The usage of ceb-content will force the initial light DOM of the ceb-element to be children of the video element.
  By this ways source, tracks ... will handled directly by the video element.
  The template is also used to defined the optional controls bar.
-->
<script id="ceb-video-template" type="text/html">
  <video ceb-content></video>
  <div class="controls" style="display: none">
    <button type="button" name="play"><i class="fa fa-play fa-fw"></i></button>
    <button type="button" name="pause" hidden><i class="fa fa-pause fa-fw"></i></button>
    <button type="button" name="stop"><i class="fa fa-stop fa-fw"></i></button>
    <input type="range" name="duration" min="0" step="1">
    <button type="button" name="mute"><i class="fa fa-volume-off fa-fw"></i></button>
    <button type="button" name="unmute"><i class="fa fa-volume-up fa-fw"></i></button>
    <input type="range" name="volume" min="0" max="1" step="0.05">
  </div>
</script>

<!-- Set the template. -->
<script>
  cebVideoBuilder.builders(
    // ceb.template() is used to fill the content of the custom element
    // from the template described above.
    ceb.template(document.getElementById('ceb-video-template').innerHTML),
    // For convenience the video element is available as property.
    ceb.property('video').getter(function (el) {
      return el.querySelector('video');
    })
  );
</script>

<!-- Toggle custom controls. -->
<script>
  cebVideoBuilder.builders(
    // When the attribute/property 'controls' is true,
    // then the controls have to be visible otherwise it should be hidden.
    ceb.attribute('controls').boolean().listen(function (el, oldVal, newVal) {
      el.querySelector('.controls').style.display = newVal ? '' : 'none';
    })
  );
</script>

<!-- Manage play/pause/stop. -->
<script>
  cebVideoBuilder.builders(
    // The sates of the play and pause button have to be synchronized with the state of the video.
    // If the video is playing, the play button has to be hidden and the pause button shown.
    // ceb.on() is used to listen the video's events helping to keep synchronized the controls states.
    ceb.on('canplay video, play video, pause video, ended video').invoke(function (el) {
      el.querySelector('.controls [name=play]').hidden = !el.video.paused && !el.video.ended;
      el.querySelector('.controls [name=pause]').hidden = el.video.paused;
    }),
    // ceb.on() is used to capture click event on the play and pause button but also to the video element it-self.
    // When the play button is pressed the video has to be played.
    // When the pause button is pressed the video has to be paused.
    // When the video element is clicked the video has to be played or paused according to its state.
    ceb.on('click').delegate('video, .controls [name=play], .controls [name=pause]').invoke(function (el) {
      if (el.video.paused) {
        el.video.play();
      } else {
        el.video.pause();
      }
    }),
    // When the button stop is pressed, the video as to be stopped.
    ceb.on('click').delegate('.controls [name=stop]').invoke(function (el) {
      el.video.pause();
      el.video.currentTime = 0;
    })
  );
</script>

<!-- Manage volume. -->
<script>
  cebVideoBuilder.builders(
    // The sound controls have to be synchronized with the video state.
    ceb.on('canplay video, volumechange video').invoke(function (el) {
      el.querySelector('.controls [name=mute]').hidden = el.video.muted;
      el.querySelector('.controls [name=unmute]').hidden = !el.video.muted;
      el.querySelector('.controls [name=volume]').value = el.video.volume;
    }),
    // When the mute or un-mute button are pressed, the video has to be muted or not accordingly.
    ceb.on('click').delegate('.controls [name=mute], .controls [name=unmute]').invoke(function (el) {
      el.video.muted = !el.video.muted;
    }),
    // When the state of range input controlling the volume is updated, the video element has to be updated as well.
    ceb.on('input,change').delegate('.controls [name=volume]').invoke(function (el, evt, input) {
      el.video.volume = input.value;
    })
  );
</script>

<!-- Manage duration. -->
<script>
  cebVideoBuilder.builders(
    // The input range managing the video progress has to be synchronized with the video state.
    ceb.on('loadeddata video, timeupdate video').invoke(function (el) {
      el.querySelector('.controls [name=duration]').max = el.video.duration;
      el.querySelector('.controls [name=duration]').value = el.video.currentTime;
    }),
    // When the state of the input range managing the video progress is update, the video element has to be updated.
    ceb.on('change,input').delegate('.controls [name=duration]').invoke(function (el, evt) {
      if (!el.video.seeking) {
        el.video.currentTime = evt.target.value;
      }
    })
  );
</script>

<script>
  cebVideoBuilder.register('ceb-video');
</script>

<!-- Create and configure the ceb-video element from HTML. -->
<ceb-video controls>
  <source src="https://www.html5rocks.com/en/tutorials/video/basics/devstories.webm"
          type='video/webm;codecs="vp8, vorbis"'/>
  <source src="https://www.html5rocks.com/en/tutorials/video/basics/devstories.mp4"
          type='video/mp4;codecs="avc1.42E01E, mp4a.40.2"'/>
</ceb-video>

</body>
</html>
