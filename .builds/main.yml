image: ubuntu/latest
environment:
  MDBOOK_VERSION: "0.3.5"
  SAUCE_CONNECT_DOWNLOAD_ON_INSTALL: "true"
  NVM_DIR: "/home/build/.nvm"
sources:
  - https://github.com/tmorin/ceb.git
secrets:
  - acf6b9a6-072c-47ec-8af0-304017a5fcec
  - 287002e6-a9ea-4a23-b61f-2be49055b936
packages:
  - xvfb
  - firefox
  - chromium-browser
tasks:
  - git: |
      cd ceb
      git fetch origin ${GITHUB_REF}
      git checkout FETCH_HEAD -b build
  - tools: |
      set +x
      wget https://github.com/rust-lang/mdBook/releases/download/v${MDBOOK_VERSION}/mdbook-v${MDBOOK_VERSION}-x86_64-unknown-linux-gnu.tar.gz -O - | tar -xz -C ceb
      wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.1/install.sh | bash
      . $NVM_DIR/nvm.sh
      nvm install --lts
      echo '. $NVM_DIR/nvm.sh' >> ~/.buildenv
      echo '. ~/saucelab.env' >> ~/.buildenv
      set -x
  - install: |
      cd ceb
      npm ci --no-progress
  - test: |
      cd ceb
      CHROME_BIN=/usr/bin/chromium-browser npm run test:ci
  #      BUILD_NUMBER="ceb-${JOB_ID}" npm test:sl
  - build: |
      cd ceb
      npm run build
      ./mdbook build
