image: ubuntu/latest
environment:
  MDBOOK_VERSION: "0.3.5"
  SAUCE_CONNECT_DOWNLOAD_ON_INSTALL: "true"
sources:
  - https://github.com/tmorin/ceb.git
secrets:
  - acf6b9a6-072c-47ec-8af0-304017a5fcec
  - 287002e6-a9ea-4a23-b61f-2be49055b936
tasks:
  - git: |
      cd ceb
      git fetch origin ${GITHUB_REF}
      git checkout FETCH_HEAD -b build
  - install: |
      wget https://github.com/rust-lang/mdBook/releases/download/v${MDBOOK_VERSION}/mdbook-v${MDBOOK_VERSION}-x86_64-unknown-linux-gnu.tar.gz -O - | tar -xz -C ceb
      wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.1/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      chmod +x $NVM_DIR/nvm.sh
      $NVM_DIR/nvm.sh
      nvm install --lts
      cd ceb
      npm ci --no-progress
  - test: |
      set +x; . ~/saucelab.env; set -x
      cd ceb
      npm test
  - build: |
      cd ceb
      npm run build
      ./mdbook build
